<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>PhoMa - Phone/Photo Manager</title>
		<link href="/static/css/bootstrap.min.css" rel="stylesheet">
	</head>
	<body>
		<div class="container">
			<h1>
				PhoMa
				<span class="pull-right">
					<a href="#" id="delete_many" class="btn btn-danger">Remove selected</a>
					<a href="#" id="download_all" class="btn btn-primary">Download selected</a>
				</span>
			</h1>
			<div class="wrapper">
				<div class="firstpage">
					Loading...
				</div>
			</div>
		</div>

		<script type="text/html" id="photolist">
			<% _.each(_.groupBy(photos, (element, index) => {
				return Math.floor(index/4);
			}), (chunk) => { %>
				<div class="row">
					<% _.each(chunk, (photo, key, list) => { %>
						<div class="col-xs-6 col-md-3">
							<div class="thumbnail">
								<a href="<%= photo.href %>">
									<img src="<%= photo.preview %>" alt="<%= photo.name %>">
								</a>
								<div class="caption">
									<label>
										<input type="checkbox" class="downsel" data-href="<%= photo.href %>" data-name="<%= photo.name %>">
										<%= photo.name %>
									</label>
								</div>
							</div>
						</div>
					<% }); %>
				</div>
			<% }); %>
			<a href="#" class="nextpage" data-page="<%= page+1 %>">More</a>
		</script>

		<script src="/static/underscore.js"></script>
		<script src="/static/jquery-3.1.1.js"></script>
		<script src="/static/js/bootstrap.min.js"></script>

		<script>
var tpl = _.template($('#photolist').html());
var loadpage = (n, $target) => {
	$target = $target || $('.firstpage');

	fetch('/page/'+n).then((resp) => {
		return resp.json();
	}).then((json) => {
		console.log(json);
		if(json.error) {
			throw json.error;
		}
		var rendered = tpl({
			page: n,
			photos: json.files,
		});
		$target.replaceWith(rendered);
	}).catch((err) => {
		var etxt = err.toString ? err.toString() : JSON.stringify(err);
		alert(etxt);
	});
};
$(() => {
	loadpage(0);

	$('body').on('click', '.nextpage', function(e) {
		e.preventDefault();
		var $this = $(this);
		var n = $this.attr('data-page');
		loadpage(n, $this);
	});

	$('#download_all').click(function(e) {
		e.preventDefault();
		$('input[type=checkbox].downsel:checked').each(function() {
			window.open($(this).data('href')+'?dl=1');
		});
	});
	$('#delete_many').click(function(e) {
		e.preventDefault();
		var names = $('input[type=checkbox].downsel:checked').map(function() {
			return $(this).data('name');
		}).get();
		$.ajax({
			method: 'POST',
			url: '/delete',
			data: {
				names: names,
			},
		}).then(function(ret) {
			alert('Delete result: ' + ret);
			window.location.reload();
		}).catch(function(err) {
			alert('Failed to delete');
		});
	});
});
		</script>
	</body>
</html>
